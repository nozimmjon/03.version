"""
Generate full analytical report in Russian - WB/IMF style
Central Bank of Uzbekistan: Credit Accessibility and Borrowing Behavior
"""

import sys
sys.stdout.reconfigure(encoding='utf-8')
import os
from docx import Document
from docx.shared import Inches, Pt, Cm, RGBColor
from docx.enum.text import WD_ALIGN_PARAGRAPH
from docx.enum.table import WD_TABLE_ALIGNMENT
from docx.enum.section import WD_ORIENT
from docx.oxml.ns import qn

base = r"D:\old\Desktop\Cerr_old\Cerr\2025\58. Марказий банк тадқиқоти\умумий репорт"
out = os.path.join(base, "claude")

doc = Document()

# ======== STYLES ========
style = doc.styles['Normal']
font = style.font
font.name = 'Calibri'
font.size = Pt(11)
style.paragraph_format.space_after = Pt(6)
style.paragraph_format.line_spacing = 1.15

# Heading styles
for level in [1, 2, 3]:
    h = doc.styles[f'Heading {level}']
    h.font.name = 'Calibri'
    h.font.color.rgb = RGBColor(0x1B, 0x3A, 0x5C)  # Dark blue
    if level == 1:
        h.font.size = Pt(16)
        h.font.bold = True
    elif level == 2:
        h.font.size = Pt(13)
        h.font.bold = True
    else:
        h.font.size = Pt(11)
        h.font.bold = True
        h.font.italic = True

def highlight_run(run):
    """Apply yellow highlight to a run using OoXML"""
    from docx.oxml.ns import qn as _qn
    rPr = run._r.get_or_add_rPr()
    highlight_elem = rPr.makeelement(_qn('w:highlight'), {_qn('w:val'): 'yellow'})
    rPr.append(highlight_elem)

def highlight_paragraph(p):
    """Apply yellow highlight to all runs in a paragraph"""
    for run in p.runs:
        highlight_run(run)

def highlight_cell(cell):
    """Apply yellow background shading to a table cell"""
    from docx.oxml.ns import qn as _qn
    tc = cell._tc
    tcPr = tc.get_or_add_tcPr()
    shading = tcPr.makeelement(_qn('w:shd'), {
        _qn('w:fill'): 'FFFF00',
        _qn('w:val'): 'clear',
    })
    tcPr.append(shading)

def add_key_finding(doc, text, yellow=False):
    """Add a highlighted key finding box"""
    p = doc.add_paragraph()
    p.paragraph_format.left_indent = Cm(1)
    p.paragraph_format.right_indent = Cm(1)
    run = p.add_run('КЛЮЧЕВОЙ ВЫВОД: ')
    run.bold = True
    run.font.color.rgb = RGBColor(0x1B, 0x3A, 0x5C)
    run.font.size = Pt(10)
    run2 = p.add_run(text)
    run2.font.size = Pt(10)
    run2.italic = True
    if yellow:
        highlight_run(run)
        highlight_run(run2)

def add_table(doc, headers, rows, title=None, yellow=False):
    """Add a formatted table"""
    if title:
        p = doc.add_paragraph()
        run = p.add_run(title)
        run.bold = True
        run.font.size = Pt(10)
        if yellow:
            highlight_run(run)
    table = doc.add_table(rows=1+len(rows), cols=len(headers))
    table.style = 'Light Shading Accent 1'
    table.alignment = WD_TABLE_ALIGNMENT.CENTER
    # Headers
    for i, h in enumerate(headers):
        cell = table.rows[0].cells[i]
        cell.text = h
        for p in cell.paragraphs:
            p.alignment = WD_ALIGN_PARAGRAPH.CENTER
            for run in p.runs:
                run.bold = True
                run.font.size = Pt(9)
        if yellow:
            highlight_cell(cell)
    # Data
    for r_idx, row in enumerate(rows):
        for c_idx, val in enumerate(row):
            cell = table.rows[r_idx+1].cells[c_idx]
            cell.text = str(val)
            for p in cell.paragraphs:
                p.alignment = WD_ALIGN_PARAGRAPH.CENTER
                for run in p.runs:
                    run.font.size = Pt(9)
            if yellow:
                highlight_cell(cell)
    doc.add_paragraph()

def add_chart(doc, filename, caption, yellow=False):
    """Add chart image with caption"""
    path = os.path.join(out, filename)
    if os.path.exists(path):
        doc.add_picture(path, width=Inches(5.5))
        last_paragraph = doc.paragraphs[-1]
        last_paragraph.alignment = WD_ALIGN_PARAGRAPH.CENTER
        p = doc.add_paragraph()
        p.alignment = WD_ALIGN_PARAGRAPH.CENTER
        run = p.add_run(caption)
        run.italic = True
        run.font.size = Pt(9)
        run.font.color.rgb = RGBColor(0x66, 0x66, 0x66)
        if yellow:
            highlight_run(run)

def add_yellow_heading(doc, text, level=1):
    """Add a heading with yellow highlight"""
    h = doc.add_heading(text, level=level)
    for run in h.runs:
        highlight_run(run)

def add_yellow_paragraph(doc, text, style=None):
    """Add a paragraph with yellow highlight"""
    if style:
        p = doc.add_paragraph(text, style=style)
    else:
        p = doc.add_paragraph(text)
    highlight_paragraph(p)
    return p

# ======================================================================
# TITLE PAGE
# ======================================================================
for _ in range(6):
    doc.add_paragraph()

p = doc.add_paragraph()
p.alignment = WD_ALIGN_PARAGRAPH.CENTER
run = p.add_run('ЦЕНТРАЛЬНЫЙ БАНК РЕСПУБЛИКИ УЗБЕКИСТАН')
run.font.size = Pt(14)
run.font.color.rgb = RGBColor(0x1B, 0x3A, 0x5C)
run.bold = True

doc.add_paragraph()

p = doc.add_paragraph()
p.alignment = WD_ALIGN_PARAGRAPH.CENTER
run = p.add_run('КРЕДИТНАЯ ДОСТУПНОСТЬ\nИ ПОВЕДЕНИЕ ЗАЁМЩИКОВ\nВ УЗБЕКИСТАНЕ')
run.font.size = Pt(22)
run.font.color.rgb = RGBColor(0x1B, 0x3A, 0x5C)
run.bold = True

doc.add_paragraph()

p = doc.add_paragraph()
p.alignment = WD_ALIGN_PARAGRAPH.CENTER
run = p.add_run('Аналитический доклад по результатам\nнационального обследования населения')
run.font.size = Pt(13)
run.font.color.rgb = RGBColor(0x66, 0x66, 0x66)
run.italic = True

for _ in range(4):
    doc.add_paragraph()

p = doc.add_paragraph()
p.alignment = WD_ALIGN_PARAGRAPH.CENTER
run = p.add_run('Ташкент — 2026')
run.font.size = Pt(12)

doc.add_page_break()

# ======================================================================
# TABLE OF CONTENTS placeholder
# ======================================================================
doc.add_heading('СОДЕРЖАНИЕ', level=1)
toc_items = [
    'Список сокращений',
    'Резюме для руководства',
    'I. Введение и контекст',
    'II. Методология исследования',
    'III. Профиль респондентов',
    'IV. Кредитная культура и источники заимствования',
    'V. Причины возникновения проблемных кредитов',
    'VI. Финансовая грамотность населения',
    'VII. Эконометрический анализ',
    'VIII. Система взыскания задолженности',
    'IX. Программа семейного предпринимательства',
    'X. Рекомендации по политике',
    'XI. Заключение',
    'Приложения',
]
for item in toc_items:
    p = doc.add_paragraph(item)
    p.paragraph_format.space_after = Pt(3)

doc.add_page_break()

# ======================================================================
# ABBREVIATIONS
# ======================================================================
doc.add_heading('Список сокращений', level=1)
abbr = [
    ('NPL', 'Non-Performing Loans — неработающие (просроченные) кредиты'),
    ('DTI', 'Debt-to-Income — отношение долга к доходу'),
    ('BNPL', 'Buy Now Pay Later — «Покупай сейчас, плати потом»'),
    ('МФО', 'Микрофинансовая организация'),
    ('КАТМ', 'Кредит ахборотлари тўплаш маркази (Бюро кредитных историй)'),
    ('ЦБ', 'Центральный банк Республики Узбекистан'),
    ('МИБ', 'Мижозлар ижро бюроси (Бюро исполнения)'),
]
add_table(doc, ['Сокращение', 'Расшифровка'], abbr)

doc.add_page_break()

# ======================================================================
# EXECUTIVE SUMMARY
# ======================================================================
doc.add_heading('Резюме для руководства', level=1)

doc.add_paragraph(
    'Настоящий доклад подготовлен по результатам национального обследования '
    '2 131 респондента во всех 14 регионах Узбекистана, проведённого по заказу '
    'Центрального банка Республики Узбекистан. Исследование направлено на '
    'комплексный анализ кредитной доступности, поведения заёмщиков и факторов, '
    'влияющих на возникновение проблемной задолженности.'
)

doc.add_heading('Ключевые выводы', level=2)

findings = [
    'Более 80% домохозяйств с доходом менее 5 млн сум являются заёмщиками, '
    'что указывает на системную зависимость малообеспеченных слоёв от кредитных ресурсов.',

    'Неформальное заимствование остаётся широко распространённым: 42% респондентов '
    'в первую очередь обращаются к семье и друзьям. В Кашкадарье (73%) и Хорезме (69%) '
    'неформальные источники доминируют над банками.',

    'Каждый пятый заёмщик с NPL тратит более 50% семейного дохода на обслуживание долга, '
    'а 34% имеют крайне нестабильный (сезонный) доход.',

    '13,5% заёмщиков с NPL не читали кредитный договор; 46% из них жалеют о взятом кредите. '
    'Онлайн-заёмщики хуже ознакомлены с условиями (13,1% не читали) по сравнению с офлайн (8,2%).',

    'Программа семейного предпринимательства имеет наивысшую долю NPL (52,9%). '
    'Главные причины: доходы ниже ожиданий (53%), бизнес не состоялся (36%), '
    'средства направлены на потребление (17%).',

    'Эконометрический анализ (N=1 370, ROC-AUC=0,679) выявил ключевые факторы NPL-риска: '
    'отсутствие стабильного дохода (OR=1,88), волатильность дохода (OR=1,18 за ступень), '
    'долговая нагрузка DTI (OR=1,12 за ступень). Защитные факторы: чтение договора (OR=0,66), '
    'высшее образование (OR=0,69), уровень дохода (OR=0,80 за ступень), '
    'возраст (OR=0,97 за каждый год).',

]
# New findings to highlight in yellow
new_findings = [
    'Детализированный анализ причин NPL подтверждает доминирование экономических факторов: '
    'снижение доходов (47,7%), непредвиденные расходы (29,0%), сезонность (24,7%). '
    'Моральный риск минимален (<1%), а 95,2% обманутых заёмщиков имеют NPL.',

    'Незнание кредитного рейтинга повышает NPL на 19 п.п. (68% vs 49%), '
    'нецелевое использование кредита — на 26 п.п. (75,9% vs 49,5%). '
    'Субъективная норма задержки >30 дней повышает NPL до 70,8%.',
]
for f in findings:
    doc.add_paragraph(f, style='List Bullet')
for f in new_findings:
    add_yellow_paragraph(doc, f, style='List Bullet')

doc.add_heading('Приоритетные рекомендации', level=2)
recs = [
    'Ужесточить требования к оценке платёжеспособности заёмщиков с нестабильным доходом '
    '(повышение весового коэффициента риска до 300% для кредитов лицам без формального дохода).',

    'Внедрить обязательное аудиовизуальное разъяснение ключевых условий кредита (2-3 мин.) '
    'перед подписанием договора, особенно для онлайн-кредитов.',

    'Регулирование рынка BNPL: установить Центральный банк в качестве регулятора, '
    'ограничить максимальный размер дополнительных платежей 50% от суммы займа в год.',

    'Реформа программы семейного предпринимательства: обязательное обучение бизнес-навыкам, '
    'индивидуальные графики платежей с учётом сезонности, выделение средств на специальные карты.',

    'Запуск национальной медиакампании по финансовой грамотности с привлечением '
    'популярных блогеров и 1-минутной социальной рекламы на телевидении.',
]
for r in recs:
    doc.add_paragraph(r, style='List Number')

doc.add_page_break()

# ======================================================================
# CHAPTER I: INTRODUCTION
# ======================================================================
doc.add_heading('I. Введение и контекст', level=1)

doc.add_paragraph(
    'За период 2021-2025 годов в Узбекистане было выдано кредитов физическим лицам '
    'на общую сумму 467 трлн сум. Объём потребительского кредитования вырос в 4 раза: '
    'с 40,5 трлн сум (2021) до 157 трлн сум (2025). При этом реальные доходы на душу '
    'населения выросли на 6,5%, тогда как расходы домохозяйств увеличились на 10,5%, '
    'что свидетельствует о нарастающем разрыве между доходами и потребительскими расходами.'
)

doc.add_paragraph(
    'Стремительный рост кредитования, не подкреплённый адекватными институциональными '
    'механизмами оценки рисков и защиты потребителей, создаёт системные угрозы: '
    'рост проблемной задолженности, чрезмерная долговая нагрузка на домохозяйства, '
    'распространение нерегулируемых форм кредитования (BNPL) и низкий уровень '
    'финансовой грамотности населения.'
)

doc.add_heading('Цели исследования', level=2)
goals = [
    'Анализ кредитной культуры и источников заимствования населения',
    'Выявление системных причин возникновения проблемных кредитов',
    'Оценка уровня финансовой грамотности заёмщиков',
    'Анализ эффективности механизмов взыскания задолженности',
    'Исследование проблем программы семейного предпринимательства',
    'Разработка рекомендаций по совершенствованию кредитной политики',
]
for g in goals:
    doc.add_paragraph(g, style='List Bullet')

doc.add_page_break()

# ======================================================================
# CHAPTER II: METHODOLOGY
# ======================================================================
doc.add_heading('II. Методология исследования', level=1)

doc.add_heading('Дизайн выборки', level=2)
doc.add_paragraph(
    'Общий объём выборки составил 2 131 респондент. Выборка включает две компоненты: '
    '(1) 1 525 заёмщиков (71,6%), отобранных из кредитного реестра Центрального банка '
    'методом многоступенчатой стратификации по региону, типу кредита и статусу платежей; '
    '(2) 606 лиц без действующих кредитных обязательств (28,4%), отобранных случайным '
    'образом. Объём выборки рассчитан по формуле Кокрана (1977) при уровне доверия более 90%. '
    'Опрос проведён методом личного интервью (face-to-face) во всех 14 регионах.'
)

doc.add_heading('Определение подвыборок', level=3)
doc.add_paragraph(
    'Разделение респондентов на «заёмщиков» и «не-заёмщиков» основано на самооценке '
    'респондентов (переменная has_loan): заёмщики N=1 525, не-заёмщики N=606. '
    'Статус платежей (NPL / задержка / своевременно) присвоен на основе реестра '
    'Центрального банка. Для 27 респондентов наблюдается расхождение: '
    'в реестре ЦБ присутствует платёжный статус, однако при опросе они указали отсутствие '
    'действующего кредита. Данное расхождение может быть связано с погашением кредита '
    'между составлением реестра и проведением опроса. В настоящем докладе все расчёты '
    'по заёмщикам основаны на переменной has_loan (N=1 525).'
)

doc.add_heading('Ограничения выборки', level=3)
doc.add_paragraph(
    'Выборка заёмщиков была стратифицирована по статусу платежей '
    '(целевая структура: 50% без задержек, 30% до 30 дней, 10% 31–90 дней, 10% более 90 дней), '
    'что означает намеренное завышение доли проблемных заёмщиков относительно '
    'их фактической доли в кредитном портфеле страны. Данный дизайн обеспечивает '
    'достаточный объём наблюдений для факторного анализа причин NPL, но не позволяет '
    'напрямую экстраполировать абсолютные доли NPL на генеральную совокупность. '
    'Все приводимые в докладе доли по статусу платежей отражают структуру обследованной '
    'выборки, а не фактические национальные показатели NPL.'
)

add_table(doc,
    ['Параметр', 'Значение'],
    [
        ['Объём выборки', '2 131 респондент'],
        ['Заёмщики / Не-заёмщики', '1 525 (71,6%) / 606 (28,4%)'],
        ['Охват регионов', '14 из 14 (все регионы)'],
        ['Охват районов', '118 районов'],
        ['Метод опроса', 'Личное интервью (face-to-face)'],
        ['Уровень доверия', '> 90%'],
        ['Период проведения', 'Февраль 2026'],
    ],
    title='Таблица 1. Основные параметры исследования'
)

doc.add_heading('Стратификация по типу кредита', level=2)
add_table(doc,
    ['Тип кредита', 'N', '%'],
    [
        ['Семейное предпринимательство', '666', '43,7%'],
        ['Микрозайм', '626', '41,0%'],
        ['Ипотека', '68', '4,5%'],
        ['Автокредит', '66', '4,3%'],
        ['Кредитная карта', '65', '4,3%'],
        ['Образовательный кредит', '21', '1,4%'],
        ['Потребительский кредит', '13', '0,9%'],
    ],
    title='Таблица 2. Распределение заёмщиков по типу кредита (N=1 525)'
)

doc.add_heading('Стратификация по статусу платежей', level=2)
add_table(doc,
    ['Статус', 'N', '%'],
    [
        ['NPL (3+ месяцев просрочки)', '792', '51,9%'],
        ['Задержка 1-3 месяца', '410', '26,9%'],
        ['Своевременная оплата', '323', '21,2%'],
    ],
    title='Таблица 3. Распределение заёмщиков по статусу платежей (N=1 525)'
)

doc.add_page_break()

# ======================================================================
# CHAPTER III: RESPONDENT PROFILE
# ======================================================================
doc.add_heading('III. Профиль респондентов', level=1)

doc.add_heading('Демографические характеристики', level=2)
add_table(doc,
    ['Показатель', 'Все (N=2131)', 'Заёмщики (N=1525)', 'Не-заёмщики (N=606)'],
    [
        ['Средний возраст', '35,2 лет', '35,3 лет', '35,1 лет'],
        ['Мужчины', '66,7%', '64,3%', '72,8%'],
        ['Женщины', '33,3%', '35,7%', '27,2%'],
        ['Женаты/замужем', '75,1%', '76,0%', '72,8%'],
        ['Высшее образование', '34,3%', '27,2%', '52,1%'],
        ['Среднее специальное', '45,9%', '50,8%', '33,5%'],
        ['Ср. размер домохозяйства', '5,3', '5,4', '5,1'],
        ['Ср. занятых членов', '1,9', '1,9', '2,1'],
    ],
    title='Таблица 4. Демографический профиль респондентов'
)

add_key_finding(doc,
    'Заёмщики существенно отличаются от не-заёмщиков по уровню образования: '
    'лишь 27,2% заёмщиков имеют высшее образование против 52,1% не-заёмщиков. '
    'Это указывает на то, что высшее образование является значимым '
    'защитным фактором от чрезмерного заимствования.')

add_chart(doc, 'chart_01_regional_distribution.png',
    'Рис. 1. Региональное распределение респондентов (N=2 131)')

doc.add_heading('Доходы домохозяйств', level=2)
add_table(doc,
    ['Уровень дохода', 'Все', 'Заёмщики', 'Не-заёмщики'],
    [
        ['До 5 млн сум', '33,3%', '38,0%', '21,5%'],
        ['5-10 млн сум', '35,8%', '35,7%', '36,0%'],
        ['10-20 млн сум', '19,6%', '16,5%', '27,6%'],
        ['20-50 млн сум', '7,0%', '5,0%', '12,2%'],
        ['Более 50 млн сум', '0,8%', '0,7%', '1,0%'],
    ],
    title='Таблица 5. Распределение по уровню ежемесячного дохода домохозяйства'
)

add_key_finding(doc,
    '81,7% респондентов с доходом менее 5 млн сум являются заёмщиками. '
    'С ростом дохода доля заёмщиков снижается до 50,7% в группе 20-50 млн сум.')

add_chart(doc, 'chart_04_income.png',
    'Рис. 2. Распределение дохода: заёмщики vs не-заёмщики (N=2 131)')
add_chart(doc, 'chart_07_income_sources.png',
    'Рис. 3. Источники дохода: заёмщики vs не-заёмщики (N=2 131)')
add_chart(doc, 'chart_08_education.png',
    'Рис. 4. Уровень образования: заёмщики vs не-заёмщики (N=2 131)')

doc.add_page_break()

# ======================================================================
# CHAPTER IV: CREDIT CULTURE
# ======================================================================
doc.add_heading('IV. Кредитная культура и источники заимствования', level=1)

doc.add_heading('Первый источник при нехватке средств', level=2)
doc.add_paragraph(
    'При возникновении потребности в дополнительных средствах 48,4% респондентов '
    'обращаются в банки, 42,0% — к семье, друзьям или знакомым, а 6,5% предпочитают '
    'искать альтернативные решения без заимствования. Доля обращающихся к микрофинансовым '
    'организациям, ломбардам и неформальным кредиторам минимальна (менее 1%).'
)

add_chart(doc, 'chart_09_first_source.png',
    'Рис. 5. Первый источник при нехватке средств (N=2 131)')

doc.add_heading('Региональные различия', level=2)
doc.add_paragraph(
    'Наблюдаются значительные региональные различия в предпочтениях. '
    'В Кашкадарье 72,7% обращаются к семье и друзьям (против 26,6% к банкам), '
    'в Хорезме — 68,6%. Напротив, в Жиззахе (60,4%), Каракалпакстане (60,7%) '
    'и Навои (57,7%) доминируют банки.'
)

add_chart(doc, 'chart_10_source_by_region.png',
    'Рис. 6. Первый источник средств по регионам (N=2 131)')

doc.add_heading('Причины выбора неформального заимствования', level=2)
doc.add_paragraph(
    'Среди 906 респондентов, предпочитающих неформальные источники, '
    'основные мотивы: отсутствие процентов (66,6%), лёгкость и скорость получения (60,5%), '
    'высокие банковские ставки (16,3%), отсутствие требований к формальному доходу (14,9%) '
    'и религиозные убеждения (11,9%).'
)

add_chart(doc, 'chart_11_why_informal.png',
    'Рис. 7. Причины обращения к неформальным источникам (N=906)')

doc.add_heading('Причины выбора банков', level=2)
doc.add_paragraph(
    'Среди 1 032 респондентов, предпочитающих банки, лидирующий фактор — '
    'чёткие и законные условия (73,4%). Далее следуют удобство и онлайн-доступ (35,9%), '
    'длительные сроки кредитования (23,7%) и более низкие процентные ставки (22,5%).'
)

add_chart(doc, 'chart_12_why_banks.png',
    'Рис. 8. Причины обращения в банки (N=1 032)')

doc.add_heading('Цели кредитования', level=2)
doc.add_paragraph(
    'Основные цели: бизнес (26,2%), семейное предпринимательство (25,8%), '
    'повседневные расходы (14,2%), покупка автомобиля (11,2%) и бытовой техники (10,1%). '
    '70,4% заёмщиков взяли кредит «для улучшения уровня жизни», 29,6% — «для выхода из кризисной ситуации».'
)

add_chart(doc, 'chart_13_credit_purpose.png',
    'Рис. 9. Цели кредитования заёмщиков (N=1 525)')

add_key_finding(doc,
    'Почти 30% заёмщиков взяли кредит вынужденно — для выхода из кризисной ситуации, '
    'а не для развития. Это указывает на недостаточность социальных страховочных механизмов.')

add_chart(doc, 'chart_14_borrowing_reason.png',
    'Рис. 10. Мотив кредитования: улучшение жизни vs выход из кризиса (N=1 525)')

doc.add_page_break()

# ======================================================================
# CHAPTER V: PROBLEM LOANS
# ======================================================================
doc.add_heading('V. Причины возникновения проблемных кредитов', level=1)

doc.add_heading('Долговая нагрузка', level=2)
doc.add_paragraph(
    'Анализ показывает чёткую связь между долговой нагрузкой и статусом платежей. '
    'Среди заёмщиков с NPL 21,3% тратят более 50% семейного дохода на обслуживание долга, '
    'тогда как среди своевременных плательщиков эта доля составляет лишь 10,4%. '
    'При этом 7,9% NPL-заёмщиков вообще не осуществляют платежей.'
)

add_chart(doc, 'chart_17_dti_by_status.png',
    'Рис. 11. Долговая нагрузка (DTI) по статусу платежей')

doc.add_heading('Нестабильность доходов', level=2)
doc.add_paragraph(
    'Волатильность дохода — один из ключевых факторов риска. Среди NPL-заёмщиков '
    '34,2% имеют «очень нестабильный/сезонный» доход, тогда как среди своевременных '
    'плательщиков — 21,4%. Стабильный доход характерен для 42,7% своевременных '
    'плательщиков, но лишь для 26,3% NPL.'
)

add_chart(doc, 'chart_18_volatility_by_status.png',
    'Рис. 12. Нестабильность доходов по статусу платежей')

doc.add_heading('Причины неплатежей', level=2)
doc.add_paragraph(
    'Среди заёмщиков с NPL (N=792) наиболее частые причины неплатежей:'
)

add_table(doc,
    ['Причина', 'NPL (%)', '1-3 мес. (%)', 'Своевр. (%)'],
    [
        ['Снижение доходов', '46,7%', '47,1%', '22,9%'],
        ['Непредвиденные расходы (болезнь и др.)', '28,4%', '27,4%', '7,3%'],
        ['Сезонный/нестабильный доход', '24,2%', '21,6%', '7,6%'],
        ['Задержка зарплаты', '12,6%', '21,2%', '16,5%'],
        ['Переоценка своих возможностей', '7,4%', '4,3%', '1,5%'],
        ['Перенаправление на другие долги', '6,4%', '7,5%', '5,2%'],
        ['Несанкционированное оформление кредита', '3,8%', '1,0%', '0,3%'],
    ],
    title='Таблица 6. Причины неплатежей по статусу (множественный ответ)'
)

add_chart(doc, 'chart_19_npl_reasons.png',
    'Рис. 13. Причины NPL (множественный ответ, N=792)')

add_key_finding(doc,
    'Тройка главных причин NPL носит макроэкономический характер (снижение доходов, '
    'непредвиденные расходы, сезонность), а не поведенческий. Это требует системных мер: '
    'страхование доходов, гибкие графики платежей, учёт сезонности при кредитовании.')

doc.add_page_break()

# ======================================================================
# CHAPTER VI: FINANCIAL LITERACY
# ======================================================================
doc.add_heading('VI. Финансовая грамотность населения', level=1)

doc.add_heading('Восприятие кредитной дисциплины', level=2)
doc.add_paragraph(
    '43,9% заёмщиков считают, что окружающие допускают «небольшие задержки» по платежам, '
    '22,1% видят «серьёзные проблемы» с погашением в своём окружении, и лишь 22,4% '
    'полагают, что люди платят вовремя. Это создаёт социальную норму допустимости просрочки.'
)

doc.add_heading('Ознакомление с договором', level=2)
add_table(doc,
    ['Показатель', 'NPL', '1-3 мес.', 'Своевременно'],
    [
        ['Полностью ознакомились', '67,6%', '79,3%', '79,6%'],
        ['Частично ознакомились', '18,9%', '14,4%', '17,6%'],
        ['Не ознакомились', '13,5%', '6,3%', '2,8%'],
    ],
    title='Таблица 7. Ознакомление с кредитным договором по статусу платежей'
)

add_chart(doc, 'chart_20_contract_by_status.png',
    'Рис. 14. Ознакомление с договором по статусу платежей')

doc.add_heading('Понимание условий кредита', level=2)
add_table(doc,
    ['Показатель', 'NPL', '1-3 мес.', 'Своевременно'],
    [
        ['Полностью понимали', '79,2%', '87,3%', '91,0%'],
        ['Думали, что понимали (но заплатили больше)', '9,2%', '7,1%', '6,2%'],
        ['Не понимали', '11,6%', '5,6%', '2,8%'],
    ],
    title='Таблица 8. Понимание условий кредита по статусу платежей'
)

add_chart(doc, 'chart_21_terms_by_status.png',
    'Рис. 15. Понимание условий кредита по статусу платежей')

doc.add_heading('Онлайн vs офлайн кредитование', level=2)
doc.add_paragraph(
    'Онлайн-заёмщики (N=360) значительно хуже ознакомлены с условиями кредита: '
    '13,1% из них не читали договор вовсе (против 8,2% у офлайн-заёмщиков). '
    'Это требует усиления требований к раскрытию информации в онлайн-каналах.'
)

add_chart(doc, 'chart_23_online_vs_offline.png',
    'Рис. 16. Ознакомление с договором: онлайн vs офлайн')

doc.add_heading('Сожаление о кредите', level=2)
doc.add_paragraph(
    'Доля сожалеющих о взятом кредите резко различается по статусу платежей: '
    '46,3% среди NPL, 26,3% среди задерживающих на 1-3 месяца и 24,5% среди '
    'своевременных плательщиков.'
)

add_chart(doc, 'chart_22_regret_by_status.png',
    'Рис. 17. Доля сожалеющих о кредите по статусу платежей')

add_key_finding(doc,
    'Существует устойчивый «градиент грамотности»: чем лучше заёмщик информирован '
    '(читал договор, понимал условия, знает о кредитном рейтинге), тем ниже '
    'вероятность NPL. Это подтверждает эффективность инвестиций в финансовое просвещение.')

doc.add_page_break()

# ======================================================================
# CHAPTER VII: ECONOMETRIC ANALYSIS
# ======================================================================
doc.add_heading('VII. Эконометрический анализ', level=1)

doc.add_paragraph(
    'Для количественной оценки факторов, влияющих на вероятность перехода '
    'кредита в категорию NPL, была построена логистическая регрессия '
    'на выборке N=1 370 заёмщиков (89,8% от общего числа заёмщиков; исключены лишь '
    '155 наблюдений с ответами «затрудняюсь ответить» по переменным дохода, DTI и волатильности). '
    'Зависимая переменная — бинарный признак NPL (1 = просрочка 3+ месяцев, 0 = иное).'
)

doc.add_heading('Спецификация модели', level=2)
doc.add_paragraph(
    'В модель включены 15 независимых переменных, охватывающих четыре группы факторов: '
    'демографические (возраст, пол, семейное положение, образование), '
    'экономические (уровень дохода, долговая нагрузка DTI, волатильность дохода), '
    'структура домохозяйства (размер, число занятых, число детей) и '
    'поведенческие (чтение договора, наличие зарплаты, бизнес, сезонная занятость, '
    'отсутствие стабильного дохода). Переменные введены в модель без стандартизации '
    'для обеспечения интерпретируемости коэффициентов в натуральных единицах '
    '(за каждый год возраста, за каждую ступень дохода и т.д.). '
    'Устойчивость оценок проверена 5-кратной перекрёстной валидацией.'
)

doc.add_heading('Качество модели', level=2)

add_table(doc,
    ['Показатель', 'Значение', 'Пояснение'],
    [
        ['Точность (accuracy)', '63,7%', 'Доля правильных классификаций'],
        ['5-fold CV accuracy', '61,8% (±2,0%)', 'Устойчивость модели на новых данных'],
        ['ROC-AUC (обучение)', '0,679', 'Способность модели разделять NPL и non-NPL'],
        ['ROC-AUC (5-fold CV)', '0,662 (±0,028)', 'Устойчивая дискриминационная способность'],
        ['Чувствительность (NPL recall)', '64,3%', 'Доля правильно выявленных NPL'],
        ['Специфичность (non-NPL recall)', '63,2%', 'Доля правильно выявленных non-NPL'],
    ],
    title='Таблица 9. Показатели качества логистической регрессии (N=1 370)'
)

doc.add_paragraph(
    'Значение ROC-AUC = 0,679 указывает на умеренную дискриминационную способность модели. '
    'Это ожидаемо для модели, основанной исключительно на социально-демографических '
    'и поведенческих факторах, без включения финансовых данных о размере кредита, '
    'процентной ставке и истории платежей. Устойчивость подтверждена кросс-валидацией '
    '(ROC-AUC CV = 0,662 ± 0,028).'
)

add_chart(doc, 'chart_32_roc_curve.png',
    'Рис. 18. ROC-кривая логистической регрессии (N=1 370, AUC=0,679)')

doc.add_heading('Матрица ошибок', level=3)

add_table(doc,
    ['', 'Предсказано: non-NPL', 'Предсказано: NPL'],
    [
        ['Факт: non-NPL (N=684)', '432 (63,2%)', '252 (36,8%)'],
        ['Факт: NPL (N=686)', '245 (35,7%)', '441 (64,3%)'],
    ],
    title='Таблица 10. Матрица ошибок классификации'
)

doc.add_heading('Результаты модели', level=2)
doc.add_paragraph(
    'Ниже представлены коэффициенты модели и отношения шансов (Odds Ratios) '
    'в натуральных единицах. OR > 1 означает увеличение шансов NPL, '
    'OR < 1 — снижение шансов NPL.'
)

add_table(doc,
    ['Переменная', 'Коэфф.', 'OR', 'Единица измерения', 'Интерпретация'],
    [
        ['Отсутствие стаб. дохода', '+0,63', '1,88', '1=да / 0=нет', 'Нет стабильного дохода: +88% к шансам NPL'],
        ['Волатильность дохода', '+0,16', '1,18', 'за ступень', 'Каждая ступень нестабильности: +18%'],
        ['Мужской пол', '+0,12', '1,13', '1=да / 0=нет', 'Мужчины: +13%'],
        ['Долговая нагрузка (DTI)', '+0,11', '1,12', 'за ступень', 'Каждая ступень DTI: +12%'],
        ['Сезонная занятость', '+0,08', '1,08', '1=да / 0=нет', 'Сезонная работа: +8%'],
        ['Размер домохозяйства', '+0,08', '1,08', 'за каждого члена', '+8% за каждого члена семьи'],
        ['Число детей', '+0,05', '1,05', 'за ребёнка', '+5% за каждого ребёнка (незначимо)'],
        ['Женат/замужем', '+0,00', '1,00', '1=да / 0=нет', 'Незначимо'],
        ['Возраст', '-0,03', '0,97', 'за каждый год', '-3% за каждый год (≈-25% за 10 лет)'],
        ['Наличие бизнеса', '-0,08', '0,93', '1=да / 0=нет', 'Наличие бизнеса: -7%'],
        ['Число занятых', '-0,14', '0,87', 'за каждого занятого', '-13% за занятого члена семьи'],
        ['Наличие зарплаты', '-0,17', '0,84', '1=да / 0=нет', 'Наличие зарплаты: -16%'],
        ['Уровень дохода', '-0,22', '0,80', 'за ступень', '-20% за каждую ступень дохода'],
        ['Высшее образование', '-0,37', '0,69', '1=да / 0=нет', 'Высшее образование: -31%'],
        ['Чтение договора', '-0,41', '0,66', '1=полностью / 0=нет', 'Чтение договора: -34%'],
    ],
    title='Таблица 11. Коэффициенты логистической регрессии в натуральных единицах (N=1 370)'
)

add_chart(doc, 'chart_24_v2_no_scaler.png',
    'Рис. 19. Odds Ratios логистической регрессии в натуральных единицах (N=1 370)')

add_chart(doc, 'chart_31_v2_odds_ratios.png',
    'Рис. 20. Отношения шансов (Odds Ratios) для факторов NPL (N=1 370)')

doc.add_heading('Интерпретация результатов', level=2)
doc.add_paragraph(
    'Факторы риска NPL (повышают вероятность):'
)
risk_factors = [
    'Отсутствие стабильного дохода (OR=1,88): наиболее сильный рисковый фактор. '
    'Заёмщики без формального дохода почти вдвое чаще оказываются в категории NPL.',
    'Волатильность дохода (OR=1,18 за ступень): каждая ступень нестабильности '
    'увеличивает шансы NPL на 18%. Сезонный доход — системный фактор, '
    'особенно в аграрных регионах.',
    'Долговая нагрузка DTI (OR=1,12 за ступень): каждая ступень роста DTI '
    'увеличивает шансы NPL на 12%.',
    'Размер домохозяйства (OR=1,08 за человека): каждый дополнительный член семьи '
    'увеличивает шансы NPL на 8%.',
]
for rf in risk_factors:
    doc.add_paragraph(rf, style='List Bullet')

doc.add_paragraph(
    'Защитные факторы (снижают вероятность NPL):'
)
protect_factors = [
    'Чтение договора (OR=0,66): наиболее сильный защитный фактор. '
    'Полное ознакомление с договором снижает шансы NPL на 34% — это наиболее '
    'управляемый фактор для регулятора.',
    'Высшее образование (OR=0,69): снижает шансы NPL на 31%.',
    'Уровень дохода (OR=0,80 за ступень): каждая ступень дохода '
    'снижает шансы NPL на 20%.',
    'Возраст (OR=0,97 за год): каждый дополнительный год возраста снижает '
    'шансы NPL на 3%, что за декаду составляет снижение на ~25%.',
]
for pf in protect_factors:
    doc.add_paragraph(pf, style='List Bullet')

add_key_finding(doc,
    'Три наиболее значимых фактора NPL: (1) отсутствие стабильного дохода (OR=1,88), '
    '(2) чтение договора (OR=0,66 — снижает шансы NPL на 34%), '
    '(3) высшее образование (OR=0,69 — снижение на 31%). '
    'Модель подтверждена 5-кратной кросс-валидацией (ROC-AUC = 0,662 ± 0,028). '
    'Чтение договора — наиболее управляемый фактор: простое регуляторное требование '
    'об обязательном ознакомлении может существенно снизить долю NPL.')

doc.add_page_break()

# ======================================================================
# CHAPTER VIII: DEBT COLLECTION
# ======================================================================
doc.add_heading('VIII. Система взыскания задолженности', level=1)

doc.add_heading('Допустимые причины просрочки (по мнению населения)', level=2)
doc.add_paragraph(
    'По мнению всех респондентов (N=2 131), наиболее допустимыми причинами '
    'задержки платежей являются: задержка зарплаты (49,4%), потеря дохода (45,7%), '
    'непредвиденные расходы (30,4%) и мошенничество (17,1%).'
)

doc.add_heading('Применяемые методы взыскания', level=2)
add_table(doc,
    ['Метод', 'Все заёмщики', 'NPL', 'Своевременно'],
    [
        ['Телефонные звонки', '74,3%', '81,3%', '43,7%'],
        ['SMS-напоминания', '60,5%', '63,7%', '49,5%'],
        ['Визит сотрудника банка', '33,8%', '47,2%', '7,0%'],
        ['Официальное предупреждение', '9,9%', '14,5%', '1,5%'],
        ['Визит МИБ', '6,4%', '10,4%', '0,0%'],
        ['Судебное производство', '2,4%', '4,0%', '0,0%'],
        ['Не применялись', '9,4%', '2,6%', '30,6%'],
    ],
    title='Таблица 12. Методы взыскания по статусу платежей'
)

add_chart(doc, 'chart_25_collection_by_status.png',
    'Рис. 21. Методы взыскания: NPL vs своевременные плательщики')

doc.add_heading('Наиболее эффективные напоминания', level=2)
doc.add_paragraph(
    'По оценке самих заёмщиков, наиболее эффективными средствами являются: '
    'телефонные звонки (64,6%), SMS (60,7%), личное объяснение (13,1%) '
    'и банковское приложение (10,4%). Мессенджеры пока малоэффективны (3,1%).'
)

add_chart(doc, 'chart_26_effective_reminders.png',
    'Рис. 22. Наиболее эффективные средства напоминания (N=1 525)')

doc.add_heading('Регистрация кредитов на имя родственников', level=2)
doc.add_paragraph(
    '15,3% заёмщиков (233 человека) признались, что регистрировали кредит на имя '
    'родственников при невозможности получить новый кредит на своё имя. '
    'Это свидетельствует о масштабах «теневого» кредитования через подставных лиц '
    'и создаёт системные риски для кредитного рынка.'
)

doc.add_page_break()

# ======================================================================
# CHAPTER IX: FAMILY ENTREPRENEURSHIP
# ======================================================================
doc.add_heading('IX. Программа семейного предпринимательства', level=1)

doc.add_heading('Общая характеристика', level=2)
doc.add_paragraph(
    'Программа семейного предпринимательства охватывает 666 респондентов (43,7% заёмщиков). '
    'Доля NPL составляет 52,9% — наивысший показатель среди всех типов кредитов. '
    'Участники программы отличаются от прочих заёмщиков: меньше мужчин (59% vs 68%), '
    'значительно меньше лиц с высшим образованием (13% vs 38%), '
    'и преимущественно низкие доходы (48,5% имеют доход менее 5 млн сум).'
)

add_chart(doc, 'chart_29_npl_by_credit_type.png',
    'Рис. 23. Доля NPL по типу кредита')

doc.add_heading('Причины неплатежей', level=2)
add_table(doc,
    ['Причина', 'N', '%'],
    [
        ['Доходы ниже ожиданий', '363', '53,1%'],
        ['Бизнес не состоялся', '247', '36,2%'],
        ['Средства направлены на потребление', '115', '16,8%'],
        ['Условия неправильно интерпретированы', '24', '3,5%'],
        ['Госкредит «не надо возвращать»', '14', '2,0%'],
    ],
    title='Таблица 13. Причины неплатежей по семейному предпринимательству (N=683*)'
)

add_chart(doc, 'chart_27_family_npl_reasons.png',
    'Рис. 24. Причины NPL по программе семейного предпринимательства')

doc.add_heading('Необходимые меры поддержки', level=2)
add_table(doc,
    ['Мера', 'N', '%'],
    [
        ['Гибкие графики платежей', '279', '40,8%'],
        ['Обучение бизнес-навыкам', '218', '31,9%'],
        ['Выдача в наличной форме и на карту', '123', '18,0%'],
        ['Помощь в составлении бизнес-плана', '110', '16,1%'],
        ['Усиление надзора', '72', '10,5%'],
        ['Поэтапное выделение кредита', '63', '9,2%'],
    ],
    title='Таблица 14. Необходимые меры поддержки (N=683*)'
)

add_chart(doc, 'chart_28_family_support.png',
    'Рис. 25. Запрашиваемые меры поддержки')

p = doc.add_paragraph()
run = p.add_run(
    '* N=683 включает всех респондентов с типом кредита «семейное предпринимательство», '
    'в т.ч. 17 человек, погасивших кредит к моменту опроса (has_loan=0). '
    'Демографический профиль (N=666) рассчитан только для действующих заёмщиков.')
run.font.size = Pt(9)
run.italic = True
run.font.color.rgb = RGBColor(0x66, 0x66, 0x66)

doc.add_heading('Региональные различия', level=2)
doc.add_paragraph(
    'Наибольшая доля NPL по семейному предпринимательству наблюдается в '
    'Джизахской области (78,3%), Хорезме (64,6%) и Фергане (60,0%). '
    'Наименьшая — в Каракалпакстане (43,1%) и Бухаре (43,5%).'
)

add_key_finding(doc,
    'Программа семейного предпринимательства нуждается в коренной реформе: '
    '52,9% участников имеют NPL, а 17% потратили кредит не по назначению. '
    'Необходимы обязательное обучение, индивидуальные графики и '
    'выдача средств на специальные целевые карты.')

doc.add_page_break()

# ======================================================================
# CHAPTER X: DETAILED NPL CAUSES + DECISION FACTORS  [NEW in v5]
# ======================================================================
add_yellow_heading(doc, 'X. Углублённый анализ причин NPL и факторов кредитного решения', level=1)

add_yellow_heading(doc, '10.1. Детализированные причины неплатежей (Q3.7)', level=2)
add_yellow_paragraph(doc,
    'Вопрос Q3.7 опроса позволяет выявить детальные причины несвоевременного погашения '
    'кредитов. Всего выделено 13 причин, которые можно сгруппировать в 4 категории: '
    'экономические, поведенческие, институциональные и связанные с моральным риском.'
)

add_table(doc,
    ['Категория', 'Причина', 'N (NPL)', '% от NPL'],
    [
        ['Экономические', 'Снижение доходов', '378', '47,7%'],
        ['Экономические', 'Непредвиденные расходы (болезнь и т.д.)', '230', '29,0%'],
        ['Экономические', 'Сезонный / нерегулярный доход', '196', '24,7%'],
        ['Экономические', 'Задержка заработной платы', '102', '12,9%'],
        ['Поведенческие', 'Переоценка своих возможностей', '60', '7,6%'],
        ['Поведенческие', 'Направил на другие долги', '52', '6,6%'],
        ['Поведенческие', '«Заплачу когда смогу»', '16', '2,0%'],
        ['Институцион.', 'Кредит оформлен без разрешения', '31', '3,9%'],
        ['Институцион.', 'Несправедливое ценообразование', '7', '0,9%'],
        ['Институцион.', 'Скрытые условия в договоре', '5', '0,6%'],
        ['Институцион.', 'Ошибка банка при обработке платежа', '4', '0,5%'],
        ['Мор. риск', '«Нет последствий за неплатёж»', '2', '0,3%'],
        ['Мор. риск', '«Другие тоже не платят»', '2', '0,3%'],
    ],
    title='Таблица 15. Детализированные причины NPL по категориям (N=1 525)',
    yellow=True
)

add_chart(doc, 'chart_33_npl_causes_detailed.png',
    'Рис. 26. Причины NPL: детализированный анализ по категориям', yellow=True)

add_yellow_paragraph(doc,
    'Анализ показывает, что подавляющее большинство причин NPL носят экономический характер: '
    'снижение доходов (47,7%), непредвиденные расходы (29,0%) и сезонность дохода (24,7%). '
    'Поведенческие причины (переоценка возможностей, перенаправление средств) составляют '
    'относительно небольшую долю (7,6% и 6,6%). Институциональные проблемы (мошенничество, '
    'скрытые условия) затрагивают около 5% заёмщиков. Моральный риск минимален (менее 1%).'
)

add_key_finding(doc,
    'Основные причины NPL — макроэкономические (снижение доходов, сезонность, непредвиденные '
    'расходы), а не поведенческие. Моральный риск («не хочу платить») составляет менее 1%. '
    'Это указывает на необходимость совершенствования оценки платёжеспособности и введения '
    'гибких графиков, а не ужесточения карательных мер.', yellow=True)

add_yellow_heading(doc, '10.2. Факторы принятия решения о кредите (Q2.10)', level=2)
add_yellow_paragraph(doc,
    'Вопрос Q2.10 выявляет, что именно повлияло на решение заёмщика взять кредит. '
    'Особый интерес представляет связь каждого фактора с последующим уровнем NPL.'
)

add_table(doc,
    ['Фактор', 'N', '% заёмщ.', 'NPL, %'],
    [
        ['Необходимость (зарурият)', '1 034', '67,8%', '50,6%'],
        ['Наличие льготы (имтиёз)', '489', '32,1%', '51,1%'],
        ['Рекомендация знакомых', '145', '9,5%', '57,2%'],
        ['Рекомендация властей / хокимията', '141', '9,2%', '49,6%'],
        ['Был обманут (алданиб)', '42', '2,8%', '95,2%'],
        ['Другое', '36', '2,4%', '69,4%'],
        ['Страх инфляции', '10', '0,7%', '50,0%'],
        ['Улучшение кредитной истории', '6', '0,4%', '50,0%'],
    ],
    title='Таблица 16. Факторы решения о кредите и уровень NPL (N=1 525)',
    yellow=True
)

add_chart(doc, 'chart_34_decision_factors.png',
    'Рис. 27. Факторы кредитного решения: частота и уровень NPL', yellow=True)

add_yellow_paragraph(doc,
    'Наиболее тревожный результат — среди заёмщиков, указавших «был обманут» (N=42), '
    'уровень NPL составляет 95,2%. Хотя это малая группа (2,8%), сам факт свидетельствует '
    'о наличии мошеннических схем в кредитном процессе. Рекомендация знакомых (N=145) '
    'также связана с повышенным NPL (57,2%), что может указывать на «пирамидальные» '
    'схемы рекомендаций. При этом рекомендация властей (N=141) не повышает NPL (49,6%).'
)

add_key_finding(doc,
    '95,2% заёмщиков, указавших мотивом «был обманут», имеют NPL. '
    'Рекомендация знакомых повышает NPL до 57,2%. Необходимо усилить '
    'защиту заёмщиков от мошенничества и навязывания кредитов через посредников.', yellow=True)

doc.add_page_break()

# ======================================================================
# CHAPTER XI: CREDIT AWARENESS AND PAYMENT BEHAVIOR  [NEW in v5]
# ======================================================================
add_yellow_heading(doc, 'XI. Кредитная осведомлённость и платёжное поведение', level=1)

add_yellow_heading(doc, '11.1. Осведомлённость о кредитном рейтинге (Q3.12–3.13)', level=2)
add_yellow_paragraph(doc,
    'Вопросы Q3.12 и Q3.13 оценивают уровень осведомлённости заёмщиков '
    'о кредитном рейтинге и последствиях просрочки. Анализ выявляет чёткую '
    'обратную связь между уровнем осведомлённости и вероятностью NPL.'
)

add_table(doc,
    ['Уровень осведомлённости (Q3.12)', 'N', '% заёмщ.', 'NPL, %'],
    [
        ['Сильно мотивирует (кучли рағбат)', '784', '51,4%', '49,0%'],
        ['Частично мотивирует (қисман рағбат)', '394', '25,8%', '47,7%'],
        ['Не мотивирует (йўқ)', '141', '9,2%', '63,1%'],
        ['Не осведомлён (маълумотга эга эмас)', '122', '8,0%', '68,0%'],
        ['Сомневаюсь (иккиланаман)', '84', '5,5%', '57,1%'],
    ],
    title='Таблица 17. Мотивирующая роль знания о кредитном рейтинге (N=1 525)',
    yellow=True
)

add_table(doc,
    ['Знание последствий просрочки (Q3.13)', 'N', '% заёмщ.', 'NPL, %'],
    [
        ['Знаю точно (аниқ биламан)', '1 114', '73,0%', '50,3%'],
        ['Знаю частично (қисман биламан)', '250', '16,4%', '50,0%'],
        ['Не знаю (билмайман)', '140', '9,2%', '66,4%'],
        ['Затрудняюсь ответить', '21', '1,4%', '66,7%'],
    ],
    title='Таблица 18. Знание последствий просрочки и уровень NPL (N=1 525)',
    yellow=True
)

add_chart(doc, 'chart_35_credit_rating_awareness.png',
    'Рис. 28. Кредитная осведомлённость и уровень NPL', yellow=True)

add_yellow_paragraph(doc,
    'Данные демонстрируют значительный разрыв в уровне NPL между осведомлёнными '
    'и неосведомлёнными заёмщиками. Те, кто не знает о кредитном рейтинге, имеют NPL 68,0% '
    'против 49,0% у тех, кого знание рейтинга «сильно мотивирует» — разница в 19 п.п. '
    'Аналогично, незнание последствий просрочки (Q3.13) повышает NPL до 66,4% '
    'по сравнению с 50,3% у осведомлённых — разница 16,1 п.п.'
)

add_key_finding(doc,
    'Незнание кредитного рейтинга повышает NPL на 19 п.п. (68,0% vs 49,0%), '
    'незнание последствий просрочки — на 16 п.п. (66,4% vs 50,3%). '
    'Финансовое просвещение является доказанным инструментом снижения NPL.', yellow=True)

add_yellow_heading(doc, '11.2. Целевое использование кредита и NPL (Q2.7–2.8)', level=2)
add_yellow_paragraph(doc,
    'Анализ целевого назначения кредитов выявляет существенные различия '
    'в уровне NPL в зависимости от цели заимствования.'
)

add_table(doc,
    ['Цель кредита', 'N', 'NPL, %', 'Риск'],
    [
        ['Здоровье (соғлиқ)', '119', '63,0%', 'Высокий'],
        ['Свадьба / торжества (тўй)', '45', '62,2%', 'Высокий'],
        ['Погашение другого долга (қарз тўлаш)', '39', '61,5%', 'Высокий'],
        ['Бизнес (бизнесни бошлаш)', '400', '57,2%', 'Повышенный'],
        ['Помощь близким (яқинларга ёрдам)', '35', '57,1%', 'Повышенный'],
        ['Бытовая техника (маиший техника)', '154', '53,9%', 'Средний'],
        ['Семейное предприним. (оилавий)', '394', '50,3%', 'Средний'],
        ['Повседневные расходы (кундалик)', '216', '48,1%', 'Средний'],
        ['Ремонт жилья (таъмирлаш)', '76', '44,7%', 'Низкий'],
        ['Автомобиль (автомобил)', '171', '43,3%', 'Низкий'],
        ['Образование (таълим)', '80', '42,5%', 'Низкий'],
        ['Ипотека (ипотека)', '102', '34,3%', 'Низкий'],
    ],
    title='Таблица 19. NPL по целевому назначению кредита (N=1 525)',
    yellow=True
)

add_chart(doc, 'chart_36_purpose_npl.png',
    'Рис. 29. Уровень NPL по целевому назначению кредита', yellow=True)

add_yellow_paragraph(doc,
    'Наивысший уровень NPL наблюдается при кредитах на здоровье (63,0%), '
    'свадьбы/торжества (62,2%) и погашение предыдущих долгов (61,5%) — '
    'все три категории связаны с непродуктивным использованием. '
    'Наименьший NPL у ипотеки (34,3%) и образовательных кредитов (42,5%), '
    'что связано с наличием обеспечения и инвестиционным характером расходов.'
)

add_yellow_paragraph(doc,
    'Особенно важен показатель целевого использования: среди заёмщиков, '
    'использовавших кредит не по назначению (N=87), NPL составляет 75,9%, '
    'а среди использовавших по назначению (N=1 384) — 49,5%. '
    'Разница в 26,4 п.п. подтверждает необходимость контроля целевого использования.'
)

add_key_finding(doc,
    'Нецелевое использование кредита повышает NPL до 75,9% (vs 49,5% при целевом). '
    'Кредиты на здоровье, свадьбы и рефинансирование долгов — зоны наивысшего риска NPL (>60%). '
    'Ипотека демонстрирует наименьший NPL (34,3%).', yellow=True)

add_yellow_heading(doc, '11.3. Нормы допустимой задержки платежа (Q3.8)', level=2)
add_yellow_paragraph(doc,
    'Вопрос Q3.8 измеряет субъективные представления заёмщиков о допустимом '
    'сроке задержки платежа. Анализ выявляет прямую связь: чем больший срок задержки '
    'заёмщик считает нормальным, тем выше вероятность его NPL.'
)

add_table(doc,
    ['Допустимая задержка', 'N', '% заёмщ.', 'NPL, %'],
    [
        ['Никакая задержка не допустима', '311', '20,4%', '49,8%'],
        ['1–7 дней', '586', '38,4%', '45,2%'],
        ['8–30 дней', '453', '29,7%', '54,5%'],
        ['Более 30 дней', '171', '11,2%', '70,8%'],
        ['Можно не платить', '4', '0,3%', '100,0%'],
    ],
    title='Таблица 20. Субъективная норма задержки платежа и NPL (N=1 525)',
    yellow=True
)

add_chart(doc, 'chart_37_payment_norms.png',
    'Рис. 30. Нормы задержки платежа и уровень NPL', yellow=True)

add_yellow_paragraph(doc,
    'Прослеживается чёткий градиент: NPL растёт с 45,2% (при норме 1–7 дней) '
    'до 70,8% (при норме 30+ дней). Заёмщики, считающие задержку более месяца нормой, '
    'имеют NPL в 1,6 раза выше, чем те, кто допускает максимум неделю. '
    'Группа с минимальным NPL (45,2%) — те, кто считает нормой задержку до 7 дней.'
)

add_yellow_heading(doc, '11.4. Приоритеты погашения задолженности (Q3.9)', level=2)
add_yellow_paragraph(doc,
    'Вопрос Q3.9 определяет, какие долги заёмщики приоритизируют для погашения в первую очередь.'
)

add_table(doc,
    ['Приоритет погашения', 'N', '% заёмщ.'],
    [
        ['Банки (банк ташкилотлари)', '1 431', '93,8%'],
        ['Долги близким (яқинлар)', '179', '11,7%'],
        ['Неформальные кредиторы (норасмий шахслар)', '169', '11,1%'],
        ['Формальная рассрочка (расмий насия)', '66', '4,3%'],
        ['Микрофинансовые орг. (микромолия)', '55', '3,6%'],
        ['Неформальная рассрочка (норасмий насия)', '21', '1,4%'],
    ],
    title='Таблица 21. Приоритеты погашения задолженности (N=1 525, множественный выбор)',
    yellow=True
)

add_chart(doc, 'chart_38_payment_priorities.png',
    'Рис. 31. Приоритеты погашения задолженности', yellow=True)

add_yellow_paragraph(doc,
    '93,8% заёмщиков ставят банковские кредиты на первое место в приоритете погашения. '
    'Это свидетельствует о высоком уровне осознания формальных обязательств. '
    'Однако около 11% также приоритизируют неформальные долги (близким и ростовщикам), '
    'что может создавать конкуренцию за ограниченные ресурсы заёмщика.'
)

add_key_finding(doc,
    'Градиент NPL по субъективной норме задержки: от 45,2% (до 7 дней) '
    'до 70,8% (30+ дней). 93,8% приоритизируют банковский долг, но '
    '11% конкурирующих неформальных обязательств создают дополнительное давление.', yellow=True)

doc.add_page_break()

# ======================================================================
# CHAPTER XII: POLICY RECOMMENDATIONS
# ======================================================================
doc.add_heading('XII. Рекомендации по политике', level=1)

doc.add_heading('A. Краткосрочные меры (до 6 месяцев)', level=2)
short_term = [
    'Обязательное 2-3-минутное аудио/видеоразъяснение ключевых условий кредита '
    'перед подписанием договора, особенно для онлайн-кредитов.',

    'Введение 48-часовой задержки для онлайн-микрокредитов свыше 5 млн сум '
    '(защита от импульсивных решений и мошенничества).',

    'Предоставление заёмщику 48-часового права безштрафной отмены покупки в рассрочку.',

    'Обязательное отображение полной стоимости товара за наличный расчёт '
    'и в рассрочку на ценниках магазинов.',

    'Запуск 1-минутной социальной рекламы на телевидении с привлечением популярных блогеров.',
]
for s in short_term:
    doc.add_paragraph(s, style='List Number')

doc.add_heading('B. Среднесрочные меры (6-18 месяцев)', level=2)
medium_term = [
    'Повышение весового коэффициента риска для микрокредитов лицам без формального дохода '
    'до 300%.',

    'Разработка Указа Президента о регулировании рынка BNPL с определением '
    'Центрального банка в качестве регулятора.',

    'Ограничение общей суммы дополнительных платежей 50% от суммы займа в год.',

    'Ограничение DTI для заёмщиков до 30 лет: максимум 5-кратный размер дохода '
    'и долговая нагрузка не более 30%.',

    'Обязательное обучение бизнес-навыкам через банковских работников на местах '
    'перед выдачей кредитов по программе семейного предпринимательства.',

    'Внедрение индивидуальных графиков платежей с учётом сезонности бизнеса.',
]
for m in medium_term:
    doc.add_paragraph(m, style='List Number')

doc.add_heading('C. Долгосрочные меры (более 18 месяцев)', level=2)
long_term = [
    'Введение обязательного страхования потери дохода для кредитов свыше определённой суммы.',

    'Обеспечение автоматического списания платежей с карт UzCard/Humo '
    'независимо от статуса карты.',

    'Создание выделенной системы профиля рисков для программы семейного предпринимательства.',

    'Переход от индивидуального к групповому кредитованию семейного предпринимательства '
    '(с ограничением 80 млн сум).',

    'Запуск масштабной национальной медиакампании по финансовой грамотности '
    'через Telegram (15M+) и Instagram (14M+).',

    'Обязательное преподавание курса личных финансов в школах.',
]
for l in long_term:
    doc.add_paragraph(l, style='List Number')

doc.add_page_break()

# ======================================================================
# CHAPTER XIII: CONCLUSION
# ======================================================================
doc.add_heading('XIII. Заключение', level=1)

doc.add_paragraph(
    'Проведённое национальное обследование 2 131 респондента выявило ряд системных '
    'проблем в сфере кредитования населения Узбекистана:'
)

# Unchanged conclusions
old_conclusions = [
    'Неформальное заимствование остаётся массовым (42% населения), особенно '
    'в южных регионах, что создаёт теневой кредитный рынок вне регулирования.',

    'Программа семейного предпринимательства требует коренной реформы '
    '(NPL 52,9%, крайне низкий уровень образования и бизнес-навыков участников).',
]
# Updated / new conclusions (highlighted yellow)
new_conclusions = [
    'Кредит стал инструментом выживания, а не развития: 67,8% заёмщиков указывают '
    '«необходимость» как основной мотив, 82% малоимущих являются заёмщиками.',

    'Подавляющее большинство причин NPL носят макроэкономический характер: '
    'снижение доходов (47,7%), непредвиденные расходы (29,0%) и сезонность (24,7%). '
    'Моральный риск минимален (менее 1%).',

    'Финансовая грамотность напрямую влияет на кредитную дисциплину: '
    'ознакомление с договором снижает шансы NPL на 34% (OR=0,66), '
    'незнание кредитного рейтинга повышает NPL на 19 п.п. (68% vs 49%).',

    'Нецелевое использование кредита резко повышает NPL (75,9% vs 49,5%), '
    'а кредиты на здоровье, свадьбы и рефинансирование долгов представляют '
    'зону наивысшего риска (NPL >60%).',

    'Среди обманутых заёмщиков (2,8%) уровень NPL достигает 95,2%, '
    'что свидетельствует о наличии мошеннических схем в кредитном процессе.',
]
# First the updated item (yellow)
add_yellow_paragraph(doc, new_conclusions[0], style='List Bullet')
# Unchanged
doc.add_paragraph(old_conclusions[0], style='List Bullet')
# New/updated items (yellow)
for c in new_conclusions[1:]:
    add_yellow_paragraph(doc, c, style='List Bullet')
# Unchanged
doc.add_paragraph(old_conclusions[1], style='List Bullet')

doc.add_paragraph(
    'Реализация предложенных рекомендаций требует координации между Центральным банком, '
    'правительством, банковским сектором и институтами финансового просвещения. '
    'Приоритетными направлениями являются: ужесточение оценки платёжеспособности, '
    'регулирование BNPL, реформа семейного предпринимательства и масштабная '
    'кампания по финансовой грамотности.'
)

# ======================================================================
# SAVE
# ======================================================================
output_path = os.path.join(out, 'report_credit_accessibility_RU_v5.docx')
doc.save(output_path)
print(f'Report saved to: {output_path}')
print(f'Total pages: ~60+ (with charts)')
print(f'v5 changes (on top of v4):')
print(f'  1. NEW Chapter X: Detailed NPL causes (13 factors, 4 categories) + Decision factors (Q2.10)')
print(f'  2. NEW Chapter XI: Credit rating awareness, purpose x NPL, payment norms, priorities')
print(f'  3. 6 new charts (33-38) and 7 new tables (15-21)')
print(f'  4. Updated conclusions with new findings')
print(f'  5. Chapters renumbered: X->XII (Recommendations), XI->XIII (Conclusion)')
